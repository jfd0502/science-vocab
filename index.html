<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Sojourn</title>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #0f172a; --accent: #16a34a; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 0; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; position: relative; }
        
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); display: flex; align-items: center; justify-content: center; z-index: 10000; color: white; }
        .login-box { background: white; color: var(--text); padding: 30px; border-radius: 15px; text-align: center; width: 90%; max-width: 400px; }

        #landingPage { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; text-align: center; transition: opacity 0.8s ease, visibility 0.8s; }
        .welcome-title { font-size: 3.5rem; font-weight: 800; letter-spacing: -1px; margin-bottom: 20px; animation: reveal 1.5s cubic-bezier(0.77, 0, 0.175, 1); }
        .start-btn { background: var(--primary); color: white; border: none; padding: 18px 36px; font-size: 1.2rem; font-weight: bold; border-radius: 50px; cursor: pointer; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4); transition: transform 0.3s, background 0.3s; animation: fadeInUp 2s ease; }
        
        @keyframes reveal { 0% { opacity: 0; transform: translateY(30px); filter: blur(10px); } 100% { opacity: 1; transform: translateY(0); filter: blur(0); } }
        @keyframes fadeInUp { 0%, 50% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }

        .mode-toggle { position: absolute; top: 15px; left: 15px; background: #64748b; color: white; border: none; border-radius: 8px; padding: 8px 14px; font-size: 0.75rem; font-weight: bold; cursor: pointer; z-index: 100; opacity: 0.6; }
        .nav-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin: 10px 0; }
        .nav-btn { background: white; border: 2px solid #e2e8f0; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .breadcrumb { font-size: 0.9rem; color: #64748b; margin-bottom: 10px; width: 100%; text-align: left; cursor: pointer; }

        .app-container { padding: 60px 20px 20px 20px; width: 100%; max-width: 600px; display: flex; flex-direction: column; align-items: center; }
        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; margin-bottom: 20px; }
        .hidden { display: none !important; }
        
        .flashcard { height: 280px; perspective: 1000px; cursor: pointer; margin: 20px 0; width: 100%; }
        .inner { position: relative; width: 100%; height: 100%; transition: 0.6s; transform-style: preserve-3d; border: 2px solid #e2e8f0; border-radius: 15px; }
        .flipped .inner { transform: rotateY(180deg); }
        .front, .back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1.4rem; padding: 20px; text-align: center; border-radius: 13px; background: white; }
        .back { background: var(--primary); color: white; transform: rotateY(180deg); font-size: 1.1rem; overflow-y: auto; }
        .card-img { max-height: 120px; max-width: 100%; margin-top: 10px; }

        .quiz-option { background: white; border: 2px solid #e2e8f0; padding: 12px; margin: 8px 0; border-radius: 8px; cursor: pointer; }
        .correct { background: #dcfce7 !important; border-color: #22c55e !important; }
        .incorrect { background: #fee2e2 !important; border-color: #ef4444 !important; }
        
        .match-container { display: flex; gap: 15px; }
        .match-item { padding: 15px; background: white; border: 2px solid #cbd5e1; border-radius: 8px; cursor: grab; text-align: center; min-height: 80px; display: flex; align-items: center; justify-content: center; width: 100%; }
        
        input, select, .main-btn { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #cbd5e1; box-sizing: border-box; }
        .main-btn { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        
        /* Edit Row Styling */
        .edit-row { display: flex; flex-direction: column; gap: 5px; background: #f8fafc; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; }
        .edit-row input { padding: 5px; margin: 2px 0; font-size: 0.85rem; }
    </style>
</head>
<body>

    <div id="landingPage">
        <h1 class="welcome-title">Vocabulary Sojourn</h1>
        <button class="start-btn" onclick="enterApp()">Click Here to Start Your Journey</button>
    </div>

    <div id="loginOverlay" class="hidden">
        <div class="login-box">
            <h2>Student Entry</h2>
            <input type="text" id="studentNameInput" placeholder="Enter Name...">
            <button class="main-btn" onclick="saveStudentName()">Continue</button>
        </div>
    </div>

    <button class="mode-toggle" onclick="protectedToggle()">Manager Mode</button>

    <div class="app-container">
        <h1>Vocabulary Sojourn</h1>
        <div id="syncStatus" style="font-size: 0.8rem; color: #64748b; margin-bottom:10px;">Syncing...</div>
        
        <div id="studyView" class="panel">
            <div id="unitSelection">
                <label><strong>Select Unit</strong></label>
                <div id="unitBtnGrid" class="nav-grid"></div>
            </div>

            <div id="listSelection" class="hidden">
                <div class="breadcrumb" onclick="backToUnits()">&larr; Back</div>
                <div id="listBtnGrid" class="nav-grid"></div>
            </div>

            <div id="studyInterface" class="hidden">
                <div class="breadcrumb" onclick="backToLists()">&larr; Back to Lists</div>
                <h3 id="activeListName"></h3>
                <div id="studentWelcome" style="font-size: 0.8rem;"></div>
                <div class="study-tabs" style="display:flex; gap:5px; margin: 10px 0;">
                    <button class="main-btn" onclick="setStudyMode('list')">List</button>
                    <button class="main-btn" onclick="setStudyMode('flash')">Flash</button>
                    <button class="main-btn" onclick="setStudyMode('quiz')">Quiz</button>
                    <button class="main-btn" onclick="setStudyMode('match')">Match</button>
                </div>
                
                <div id="listMode"><div id="fullListArea"></div></div>
                <div id="flashMode" class="hidden">
                    <div class="flashcard" onclick="this.classList.toggle('flipped')">
                        <div class="inner"><div class="front" id="displayTerm"></div><div class="back" id="displayDef"></div></div>
                    </div>
                    <button class="main-btn" onclick="changeCard(1)">Next Card</button>
                </div>
                <div id="quizMode" class="hidden"><div id="quizContent"></div><div id="quizEnd" class="hidden"></div></div>
                <div id="matchMode" class="hidden"><div id="matchContent"></div><div id="matchEnd" class="hidden"></div></div>
            </div>
        </div>

        <div id="adminView" class="panel hidden">
            <div class="breadcrumb" onclick="protectedToggle()">&larr; Exit Manager</div>
            <h3>Manager Mode (Live Edit)</h3>
            <select id="adminDropdown" onchange="renderAdminList(this.value)"></select>
            <div id="adminWordList" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSwbPmk1KJuwC8y8oBy_oKB7N8LMfgJcA7LykdRSsaAj-imKQnf4ZkF6h6A28P74Ibx-lRtHclXtlF4/pub?gid=0&single=true&output=csv";
        const EXPORT_URL = "https://script.google.com/macros/s/AKfycbz6lRs9GIbrBoiviALhFwF8B6PQpxwxpcWtAUPVroOSRd_7U_3Pem5ZmRJhAibLDtonpQ/exec"; 
        const ADMIN_PASS = "science123";

        let units = {};
        let currentUnit = "", currentClass = "", cardIdx = 0, studentName = "";

        window.onload = fetchTeacherData;

        function enterApp() { 
            document.getElementById('landingPage').classList.add('hidden'); 
            document.getElementById('loginOverlay').classList.remove('hidden'); 
        }

        function saveStudentName() {
            studentName = document.getElementById('studentNameInput').value;
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('studentWelcome').innerText = "Student: " + studentName;
        }

        async function fetchTeacherData() {
            const response = await fetch(SHEET_CSV_URL);
            const csvText = await response.text();
            const rows = csvText.split(/\r?\n/).slice(1);
            units = {};
            rows.forEach(row => {
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (cols.length >= 2) {
                    const t = cols[0].replace(/"/g, ''), d = cols[1].replace(/"/g, ''), i = cols[2].replace(/"/g, ''), l = cols[3].replace(/"/g, ''), u = cols[4].replace(/"/g, '');
                    if (!units[u]) units[u] = {};
                    if (!units[u][l]) units[u][l] = [];
                    units[u][l].push({t, d, img: i});
                }
            });
            renderUnitSelection();
            populateAdminDropdown();
            document.getElementById('syncStatus').innerText = "Connected to Live Sheet";
        }

        function renderUnitSelection() {
            document.getElementById('unitBtnGrid').innerHTML = Object.keys(units).map(u => `<button class="nav-btn" onclick="selectUnit('${u}')">${u}</button>`).join('');
        }

        function selectUnit(u) {
            currentUnit = u;
            document.getElementById('unitSelection').classList.add('hidden');
            document.getElementById('listSelection').classList.remove('hidden');
            document.getElementById('listBtnGrid').innerHTML = Object.keys(units[u]).map(l => `<button class="nav-btn" onclick="selectList('${l}')">${l}</button>`).join('');
        }

        function selectList(l) {
            currentClass = l;
            document.getElementById('listSelection').classList.add('hidden');
            document.getElementById('studyInterface').classList.remove('hidden');
            document.getElementById('activeListName').innerText = l;
            setStudyMode('list');
        }

        function backToUnits() { document.getElementById('listSelection').classList.add('hidden'); document.getElementById('unitSelection').classList.remove('hidden'); }
        function backToLists() { document.getElementById('studyInterface').classList.add('hidden'); document.getElementById('listSelection').classList.remove('hidden'); }

        function setStudyMode(mode) {
            ['listMode', 'flashMode', 'quizMode', 'matchMode'].forEach(m => document.getElementById(m).classList.add('hidden'));
            document.getElementById(mode + 'Mode').classList.remove('hidden');
            const list = units[currentUnit][currentClass];
            if (mode === 'list') renderFullList(list);
            if (mode === 'flash') updateCard(list);
            if (mode === 'quiz') startQuiz(list);
        }

        function renderFullList(list) {
            document.getElementById('fullListArea').innerHTML = list.map(i => `<div style="padding:10px; border-bottom:1px solid #eee;"><strong>${i.t}</strong>: ${i.d}</div>`).join('');
        }

        function updateCard(list) {
            document.getElementById('displayTerm').innerText = list[cardIdx].t;
            document.getElementById('displayDef').innerText = list[cardIdx].d;
        }

        function changeCard(dir) {
            const list = units[currentUnit][currentClass];
            cardIdx = (cardIdx + dir + list.length) % list.length;
            updateCard(list);
        }

        // --- ADMIN FUNCTIONS ---
        function populateAdminDropdown() {
            const dropdown = document.getElementById('adminDropdown');
            dropdown.innerHTML = '<option value="">-- Select List to Edit --</option>';
            Object.keys(units).forEach(u => Object.keys(units[u]).forEach(l => {
                dropdown.innerHTML += `<option value="${u}|${l}">${u} - ${l}</option>`;
            }));
        }

        function renderAdminList(val) {
            if (!val) return;
            const [u, l] = val.split('|');
            const list = units[u][l];
            document.getElementById('adminWordList').innerHTML = list.map((item, idx) => `
                <div class="edit-row">
                    <input type="text" id="t-${idx}" value="${item.t}">
                    <input type="text" id="d-${idx}" value="${item.d}">
                    <input type="text" id="i-${idx}" value="${item.img}" placeholder="Image URL">
                    <button class="main-btn" style="background:var(--accent); padding:5px; margin:0;" onclick="saveEdit('${u}','${l}',${idx})">Save Change to Sheet</button>
                </div>
            `).join('');
        }

        async function saveEdit(u, l, idx) {
            const oldTerm = units[u][l][idx].t;
            const newTerm = document.getElementById(`t-${idx}`).value;
            const newDef = document.getElementById(`d-${idx}`).value;
            const newImg = document.getElementById(`i-${idx}`).value;

            if (!confirm("Confirm permanent change to Google Sheet?")) return;

            const payload = JSON.stringify({
                action: "updateWord",
                unit: u, list: l,
                oldTerm: oldTerm, newTerm: newTerm, newDef: newDef, newImg: newImg
            });

            await fetch(EXPORT_URL, { method: 'POST', mode: 'no-cors', body: payload });
            alert("Update command sent! Refresh app to see changes.");
        }

        async function exportResult(mode, score) {
            const payload = JSON.stringify({ action: "saveResult", name: studentName, unit: currentClass, mode: mode, score: score });
            fetch(EXPORT_URL, { method: 'POST', mode: 'no-cors', body: payload });
        }

        function protectedToggle() {
            if (document.getElementById('adminView').classList.contains('hidden')) {
                if (prompt("Password:") === ADMIN_PASS) {
                    document.getElementById('studyView').classList.add('hidden');
                    document.getElementById('adminView').classList.remove('hidden');
                }
            } else {
                document.getElementById('adminView').classList.add('hidden');
                document.getElementById('studyView').classList.remove('hidden');
            }
        }
    </script>
</body>
</html>