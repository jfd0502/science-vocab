<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Sojourn</title>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #0f172a; --accent: #16a34a; --danger: #dc2626; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 0; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; position: relative; }
        
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); display: flex; align-items: center; justify-content: center; z-index: 10000; color: white; }
        .login-box { background: white; color: var(--text); padding: 30px; border-radius: 15px; text-align: center; width: 90%; max-width: 400px; }

        #landingPage { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; text-align: center; transition: opacity 0.8s ease; }
        .welcome-title { font-size: 3.5rem; font-weight: 800; margin-bottom: 20px; }
        .start-btn { background: var(--primary); color: white; border: none; padding: 18px 36px; font-size: 1.2rem; font-weight: bold; border-radius: 50px; cursor: pointer; }
        
        .mode-toggle { position: absolute; top: 15px; left: 15px; background: #64748b; color: white; border: none; border-radius: 8px; padding: 8px 14px; font-size: 0.75rem; cursor: pointer; z-index: 100; }
        .nav-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin: 10px 0; }
        .nav-btn { background: white; border: 2px solid #e2e8f0; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .breadcrumb { font-size: 0.9rem; color: #64748b; margin-bottom: 10px; cursor: pointer; text-align: left; width: 100%; }

        .app-container { padding: 60px 20px 20px 20px; width: 100%; max-width: 600px; }
        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .hidden { display: none !important; }
        
        input, select, .main-btn { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #cbd5e1; box-sizing: border-box; }
        .main-btn { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        
        .edit-row { background: #f8fafc; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; }
        .edit-row input { padding: 8px; margin-bottom: 5px; font-size: 0.9rem; }
        .btn-group { display: flex; gap: 5px; }
        .delete-btn { background: var(--danger); color: white; border: none; border-radius: 8px; padding: 8px; cursor: pointer; flex: 1; font-weight: bold; }
        .save-btn { background: var(--accent); color: white; border: none; border-radius: 8px; padding: 8px; cursor: pointer; flex: 2; font-weight: bold; }
        
        #addWordForm { background: #eff6ff; border: 2px dashed var(--primary); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="landingPage">
        <h1 class="welcome-title">Vocabulary Sojourn</h1>
        <button class="start-btn" onclick="enterApp()">Click Here to Start Your Journey</button>
    </div>

    <div id="loginOverlay" class="hidden">
        <div class="login-box">
            <h2>Student Entry</h2>
            <input type="text" id="studentNameInput" placeholder="Enter Full Name...">
            <button class="main-btn" onclick="saveStudentName()">Continue</button>
        </div>
    </div>

    <button class="mode-toggle" onclick="protectedToggle()">Manager Mode</button>

    <div class="app-container">
        <div id="syncStatus" style="font-size: 0.75rem; color: #94a3b8; margin-bottom:5px;">Connecting...</div>
        
        <div id="studyView" class="panel">
            <div id="unitSelection">
                <label><strong>Select Unit</strong></label>
                <div id="unitBtnGrid" class="nav-grid"></div>
            </div>
            <div id="listSelection" class="hidden">
                <div class="breadcrumb" onclick="backToUnits()">&larr; Back</div>
                <div id="listBtnGrid" class="nav-grid"></div>
            </div>
            <div id="studyInterface" class="hidden">
                <div class="breadcrumb" onclick="backToLists()">&larr; Back to Lists</div>
                <h3 id="activeListName"></h3>
                <div id="listMode"><div id="fullListArea"></div></div>
            </div>
        </div>

        <div id="adminView" class="panel hidden">
            <div class="breadcrumb" onclick="protectedToggle()">&larr; Exit Manager</div>
            <h3>Manager Mode (Live Edit)</h3>
            
            <select id="adminDropdown" onchange="renderAdminList(this.value)"></select>

            <div id="addWordForm" class="hidden">
                <h4>+ Add Word to this List</h4>
                <input type="text" id="newWordT" placeholder="Word (Term)">
                <input type="text" id="newWordD" placeholder="Definition">
                <input type="text" id="newWordI" placeholder="Image URL (Optional)">
                <button class="main-btn" onclick="submitNewWord()">Add to Google Sheet</button>
            </div>

            <div id="adminWordList"></div>
        </div>
    </div>

    <script>
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSwbPmk1KJuwC8y8oBy_oKB7N8LMfgJcA7LykdRSsaAj-imKQnf4ZkF6h6A28P74Ibx-lRtHclXtlF4/pub?gid=0&single=true&output=csv";
        const EXPORT_URL = "https://script.google.com/macros/s/AKfycbyYQ-YFHElOZc-9790k4Jbt6wFzpd-pgeZxiaX8juopvKREBwtiEvCtm9sTPXH-kAuDjw/exec"; 
        const ADMIN_PASS = "science123";

        let units = {};
        let currentUnit = "", currentClass = "", studentName = "";

        window.onload = fetchTeacherData;

        function enterApp() { document.getElementById('landingPage').classList.add('hidden'); document.getElementById('loginOverlay').classList.remove('hidden'); }
        function saveStudentName() { studentName = document.getElementById('studentNameInput').value; document.getElementById('loginOverlay').classList.add('hidden'); }

        async function fetchTeacherData() {
            try {
                const response = await fetch(SHEET_CSV_URL);
                const csvText = await response.text();
                const rows = csvText.split(/\r?\n/).slice(1);
                units = {};
                rows.forEach(row => {
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if (cols.length >= 2) {
                        const t = cols[0].replace(/"/g, ''), d = cols[1].replace(/"/g, ''), i = cols[2].replace(/"/g, ''), l = cols[3].replace(/"/g, ''), u = cols[4].replace(/"/g, '');
                        if (!units[u]) units[u] = {};
                        if (!units[u][l]) units[u][l] = [];
                        units[u][l].push({t, d, img: i});
                    }
                });
                renderUnitSelection();
                populateAdminDropdown();
                document.getElementById('syncStatus').innerText = "Live Sync Active";
            } catch (e) { document.getElementById('syncStatus').innerText = "Sync Error"; }
        }

        function renderUnitSelection() {
            document.getElementById('unitBtnGrid').innerHTML = Object.keys(units).map(u => `<button class="nav-btn" onclick="selectUnit('${u}')">${u}</button>`).join('');
        }

        function selectUnit(u) {
            currentUnit = u;
            document.getElementById('unitSelection').classList.add('hidden');
            document.getElementById('listSelection').classList.remove('hidden');
            document.getElementById('listBtnGrid').innerHTML = Object.keys(units[u]).map(l => `<button class="nav-btn" onclick="selectList('${l}')">${l}</button>`).join('');
        }

        function selectList(l) {
            currentClass = l;
            document.getElementById('listSelection').classList.add('hidden');
            document.getElementById('studyInterface').classList.remove('hidden');
            document.getElementById('activeListName').innerText = l;
            renderFullList(units[currentUnit][l]);
        }

        function backToUnits() { document.getElementById('listSelection').classList.add('hidden'); document.getElementById('unitSelection').classList.remove('hidden'); }
        function backToLists() { document.getElementById('studyInterface').classList.add('hidden'); document.getElementById('listSelection').classList.remove('hidden'); }
        function renderFullList(list) { document.getElementById('fullListArea').innerHTML = list.map(i => `<div style="padding:10px; border-bottom:1px solid #eee;"><strong>${i.t}</strong>: ${i.d}</div>`).join(''); }

        function populateAdminDropdown() {
            const dropdown = document.getElementById('adminDropdown');
            dropdown.innerHTML = '<option value="">-- Select List to Manage --</option>';
            Object.keys(units).forEach(u => Object.keys(units[u]).forEach(l => {
                dropdown.innerHTML += `<option value="${u}|${l}">${u} - ${l}</option>`;
            }));
        }

        function renderAdminList(val) {
            if (!val) { document.getElementById('addWordForm').classList.add('hidden'); return; }
            document.getElementById('addWordForm').classList.remove('hidden');
            const [u, l] = val.split('|');
            const list = units[u][l];
            document.getElementById('adminWordList').innerHTML = list.map((item, idx) => `
                <div class="edit-row">
                    <input type="text" id="t-${idx}" value="${item.t}">
                    <input type="text" id="d-${idx}" value="${item.d}">
                    <input type="text" id="i-${idx}" value="${item.img}">
                    <div class="btn-group">
                        <button class="delete-btn" onclick="deleteWord('${u}','${l}',${idx})">Delete</button>
                        <button class="save-btn" onclick="saveEdit('${u}','${l}',${idx})">Update Row</button>
                    </div>
                </div>
            `).join('');
        }

        async function submitNewWord() {
            const val = document.getElementById('adminDropdown').value;
            const [u, l] = val.split('|');
            const t = document.getElementById('newWordT').value;
            const d = document.getElementById('newWordD').value;
            const i = document.getElementById('newWordI').value;

            if(!t || !d) return alert("Word and Definition are required.");
            
            const payload = JSON.stringify({ action: "addWord", unit: u, list: l, term: t, def: d, img: i });
            document.getElementById('syncStatus').innerText = "Adding Word...";
            await fetch(EXPORT_URL, { method: 'POST', mode: 'no-cors', body: payload });
            alert("Added! Please refresh the page.");
            location.reload();
        }

        async function saveEdit(u, l, idx) {
            const oldT = units[u][l][idx].t;
            const payload = JSON.stringify({
                action: "updateWord", unit: u, list: l, oldTerm: oldT,
                newTerm: document.getElementById(`t-${idx}`).value,
                newDef: document.getElementById(`d-${idx}`).value,
                newImg: document.getElementById(`i-${idx}`).value
            });
            await fetch(EXPORT_URL, { method: 'POST', mode: 'no-cors', body: payload });
            alert("Updated!");
        }

        async function deleteWord(u, l, idx) {
            const t = units[u][l][idx].t;
            if (!confirm(`Are you sure you want to PERMANENTLY delete "${t}" from the Google Sheet?`)) return;

            const payload = JSON.stringify({ action: "deleteWord", unit: u, list: l, term: t });
            document.getElementById('syncStatus').innerText = "Deleting...";
            await fetch(EXPORT_URL, { method: 'POST', mode: 'no-cors', body: payload });
            alert("Deleted! Page will now reload.");
            location.reload();
        }

        function protectedToggle() {
            if (document.getElementById('adminView').classList.contains('hidden')) {
                if (prompt("Password:") === ADMIN_PASS) {
                    document.getElementById('studyView').classList.add('hidden');
                    document.getElementById('adminView').classList.remove('hidden');
                }
            } else {
                document.getElementById('adminView').classList.add('hidden');
                document.getElementById('studyView').classList.remove('hidden');
            }
        }
    </script>
</body>
</html>