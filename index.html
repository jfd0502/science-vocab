<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Sojourn</title>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #0f172a; --accent: #16a34a; --danger: #dc2626; }
        body { font-family: 'Segoe UI', sans-serif; background: rgb(10, 15, 28); color: var(--text); padding: 0; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; position: relative; overflow-x: hidden; }
        .app-container, .mode-toggle { z-index: 1; opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
        #matrixCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        #landingPage { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s ease; }
        .welcome-title { font-size: 3.5rem; font-weight: 800; letter-spacing: -1px; margin-bottom: 20px; color: white; animation: reveal 1.2s cubic-bezier(0.77, 0, 0.175, 1) forwards; text-shadow: 0 0 25px rgba(37, 99, 235, 1), 0 2px 10px rgba(0,0,0,1); }
        .sojourn-def { font-style: italic; font-size: 1.2rem; color: #f8fafc; margin-bottom: 40px; opacity: 0; animation: reveal 1s ease forwards; animation-delay: 0.8s; max-width: 80%; text-shadow: 0 2px 10px rgba(0,0,0,1); text-align: center; }
        .start-btn { background: var(--primary); color: white; border: none; padding: 18px 36px; font-size: 1.2rem; font-weight: bold; border-radius: 50px; cursor: pointer; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.6); transition: transform 0.3s, background 0.3s; opacity: 0; animation: reveal 1s ease forwards; animation-delay: 1.4s; }
        .start-btn:hover { transform: scale(1.05); background: #1d4ed8; }
        @keyframes reveal { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); display: flex; align-items: center; justify-content: center; z-index: 20000; color: white; }
        .login-box { background: white; color: var(--text); padding: 30px; border-radius: 15px; text-align: center; width: 90%; max-width: 400px; }
        .mode-toggle { position: absolute; top: 15px; left: 15px; background: #64748b; color: white; border: none; border-radius: 8px; padding: 8px 14px; font-size: 0.75rem; cursor: pointer; }
        .nav-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin: 10px 0; }
        .nav-btn { background: white; border: 2px solid #e2e8f0; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .breadcrumb { font-size: 0.9rem; color: #64748b; margin-bottom: 10px; cursor: pointer; text-align: left; width: 100%; }
        .app-container { padding: 60px 20px 20px 20px; width: 100%; max-width: 600px; display: flex; flex-direction: column; position: relative; }
        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; width: 100%; box-sizing: border-box; }
        .hidden { display: none !important; }
        .study-tabs { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .study-tabs button { flex: 1; padding: 10px; font-size: 0.85rem; border: none; border-radius: 8px; cursor: pointer; background: #e2e8f0; }
        .study-tabs button.active { background: var(--primary); color: white; }
        .flashcard { height: 320px; perspective: 1000px; cursor: pointer; margin: 20px 0; }
        .inner { position: relative; width: 100%; height: 100%; transition: 0.6s; transform-style: preserve-3d; border: 2px solid #e2e8f0; border-radius: 15px; }
        .flipped .inner { transform: rotateY(180deg); }
        .front, .back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; box-sizing: border-box; border-radius: 13px; background: white; }
        .front { font-size: 1.6rem; font-weight: bold; }
        .back { background: var(--primary); color: white; transform: rotateY(180deg); font-size: 1.1rem; overflow-y: auto; }
        
        /* Image Styling */
        .vocab-img { max-width: 100%; max-height: 120px; border-radius: 8px; margin-bottom: 15px; object-fit: contain; }
        .list-img { width: 60px; height: 60px; border-radius: 4px; object-fit: cover; margin-right: 15px; }
        .list-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }

        .quiz-option { background: white; border: 2px solid #e2e8f0; padding: 12px; margin: 8px 0; border-radius: 8px; cursor: pointer; text-align: left; }
        .correct { background: #dcfce7 !important; border-color: #22c55e !important; }
        .incorrect { background: #fee2e2 !important; border-color: #ef4444 !important; }
        .match-container { display: flex; gap: 15px; margin-top: 10px; }
        .match-col { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .match-item { padding: 10px; background: white; border: 2px solid #cbd5e1; border-radius: 8px; cursor: grab; text-align: center; min-height: 80px; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; }
        input, select, .main-btn { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #cbd5e1; box-sizing: border-box; }
        .main-btn { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .main-btn:disabled { background: #94a3b8; cursor: not-allowed; }
        .delete-btn { background: var(--danger); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .delete-btn:disabled { background: #fca5a5; cursor: not-allowed; }
        .edit-row { background: #f8fafc; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; }

        .spinner { width: 18px; height: 18px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading .spinner { display: inline-block; }
    </style>
</head>
<body>

    <canvas id="matrixCanvas"></canvas>

    <div id="landingPage">
        <h1 class="welcome-title">Vocabulary Sojourn</h1>
        <div class="sojourn-def">so-journ (n): a temporary stay in a place.</div>
        <button class="start-btn" onclick="enterApp()">Click Here to Start Your Journey</button>
    </div>

    <div id="loginOverlay" class="hidden">
        <div class="login-box">
            <h2>Student Entry</h2>
            <input type="text" id="studentNameInput" placeholder="Enter Full Name...">
            <button class="main-btn" onclick="saveStudentName()">Continue</button>
        </div>
    </div>

    <button class="mode-toggle" onclick="protectedToggle()">Manager Mode</button>

    <div class="app-container">
        <div id="syncStatus" style="font-size: 0.75rem; color: #94a3b8; text-align:center; margin-bottom:10px;">Connecting...</div>
        <div id="studyView" class="panel">
            <div id="unitSelection">
                <label><strong>Select Unit</strong></label>
                <div id="unitBtnGrid" class="nav-grid"></div>
            </div>
            <div id="listSelection" class="hidden">
                <div class="breadcrumb" onclick="backToUnits()">&larr; Back to Units</div>
                <div id="listBtnGrid" class="nav-grid"></div>
            </div>
            <div id="studyInterface" class="hidden">
                <div class="breadcrumb" onclick="backToLists()">&larr; Back to Lists</div>
                <h3 id="activeListName" style="margin:5px 0;"></h3>
                <div id="studentWelcome" style="font-size: 0.8rem; color: #64748b; margin-bottom: 10px;"></div>
                <div class="study-tabs">
                    <button id="tabList" class="active" onclick="setStudyMode('list')">List</button>
                    <button id="tabFlash" onclick="setStudyMode('flash')">Flashcards</button>
                    <button id="tabQuiz" onclick="setStudyMode('quiz')">Quiz</button>
                    <button id="tabMatch" onclick="setStudyMode('match')">Matching</button>
                </div>
                <div id="listMode">
                    <div id="fullListArea"></div>
                    <div id="historyLogArea" style="margin-top:20px; background:#f8fafc; padding:15px; border-radius:8px;">
                        <h4 style="margin:0 0 10px 0;">Session Performance:</h4>
                        <div id="historyEntries">No attempts yet.</div>
                    </div>
                </div>
                <div id="flashMode" class="hidden"><div class="flashcard" id="cardContainer" onclick="this.classList.toggle('flipped')"><div class="inner"><div class="front" id="displayFront"></div><div class="back" id="displayBack"></div></div></div><div style="display:flex; gap:10px;"><button class="main-btn" onclick="changeCard(-1)">Prev</button><button class="main-btn" onclick="changeCard(1)">Next</button></div></div>
                <div id="quizMode" class="hidden"><div id="quizStats" style="text-align:right; font-weight:bold; color:var(--primary);">Score: 0/0</div><div id="quizContent"><div id="quizQuestion" style="font-weight:bold; margin-bottom:15px;"></div><div id="quizOptions"></div><button id="nextQuizBtn" class="hidden main-btn" onclick="renderQuiz()">Next Question</button></div><div id="quizEnd" class="hidden" style="text-align:center;"></div></div>
                <div id="matchMode" class="hidden"><div id="matchStats" style="text-align:right; font-weight:bold; color:var(--primary);">Accuracy: 0%</div><div id="matchContainer" class="match-container"></div><div id="matchEnd" class="hidden" style="text-align:center;"></div></div>
            </div>
        </div>

        <div id="adminView" class="panel hidden">
            <div class="breadcrumb" onclick="protectedToggle()">&larr; Exit Manager</div>
            <h3>Manager Mode (Live Edit)</h3>
            <select id="adminDropdown" onchange="renderAdminList(this.value)"></select>
            <div id="addWordForm" class="hidden">
                <h4 style="margin-bottom:10px;">+ Add New Word</h4>
                <input type="text" id="newT" placeholder="New Term">
                <input type="text" id="newD" placeholder="New Definition">
                <input type="text" id="newI" placeholder="Image URL (optional)">
                <button class="main-btn" id="addWordBtn" onclick="submitNewWord()">
                    <span class="spinner"></span>
                    <span class="btn-text">Add Word to Sheet</span>
                </button>
                <hr style="margin: 20px 0;">
            </div>
            <div id="adminWordList"></div>
        </div>
    </div>

    <script>
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSwbPmk1KJuwC8y8oBy_oKB7N8LMfgJcA7LykdRSsaAj-imKQnf4ZkF6h6A28P74Ibx-lRtHclXtlF4/pub?gid=0&single=true&output=csv";
        const EXPORT_URL = "https://script.google.com/macros/s/AKfycbxSEgFIUtxwYTIWbDFwOVQTExvZE1bzYoKP1aQhwPwDiJ0A5A_tUNm62wZxcI8sHyAfVw/exec"; 
        const ADMIN_PASS = "science123";

        let units = {}, currentUnit = "", currentClass = "", cardIdx = 0, studentName = "", draggedItem = null, sessionHistory = [];
        let vocabWords = ["Sojourn", "Voyage", "Discovery", "Knowledge"]; 

        const canvas = document.getElementById('matrixCanvas');
        const ctx = canvas.getContext('2d');
        let columns = [];

        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; columns = Array(Math.floor(canvas.width / 20)).fill(0); }
        function drawMatrix() { ctx.fillStyle = "rgba(10, 15, 28, 0.15)"; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = "#3b82f6"; ctx.font = "bold 15px monospace"; columns.forEach((y, i) => { const word = vocabWords[Math.floor(Math.random() * vocabWords.length)]; ctx.fillText(word, i * 25, y); if (y > canvas.height && Math.random() > 0.95) columns[i] = 0; else columns[i] = y + 25; }); }
        window.onload = () => { fetchTeacherData(); resizeCanvas(); setInterval(drawMatrix, 50); };

        function enterApp() { 
            document.getElementById('landingPage').style.opacity = '0'; 
            canvas.style.opacity = '0';
            setTimeout(() => { 
                document.getElementById('landingPage').classList.add('hidden'); 
                canvas.classList.add('hidden'); 
                document.getElementById('loginOverlay').classList.remove('hidden'); 
            }, 800); 
        }

        function saveStudentName() { 
            studentName = document.getElementById('studentNameInput').value; 
            if(studentName.trim()){ 
                document.getElementById('loginOverlay').classList.add('hidden'); 
                document.getElementById('studentWelcome').innerText = "Student: " + studentName;
                const container = document.querySelector('.app-container');
                const toggle = document.querySelector('.mode-toggle');
                container.style.opacity = '1'; 
                container.style.pointerEvents = 'auto'; 
                toggle.style.opacity = '0.6'; 
                toggle.style.pointerEvents = 'auto';
            } else { 
                alert("Please enter your name."); 
            } 
        }

        async function fetchTeacherData() {
            try {
                const response = await fetch(`${SHEET_CSV_URL}&cachebust=${Date.now()}`); 
                const csvText = await response.text();
                const rows = csvText.split(/\r?\n/).filter(row => row.trim().length > 0).slice(1); 
                units = {}; 
                let allTerms = [];
                
                rows.forEach(row => {
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
                    if (cols.length >= 5) {
                        const [term, def, img, listName, unitName] = cols;
                        if (!units[unitName]) units[unitName] = {}; 
                        if (!units[unitName][listName]) units[unitName][listName] = []; 
                        units[unitName][listName].push({t: term, d: def, img: img});
                        allTerms.push(term);
                    }
                });

                if(allTerms.length > 0) vocabWords = [...new Set(allTerms)];
                renderUnitSelection(); 
                populateAdminDropdown(); 
                document.getElementById('syncStatus').innerText = "Sync Active";
            } catch (e) { 
                document.getElementById('syncStatus').innerText = "Sync Error"; 
            }
        }

        function renderUnitSelection() { 
            const grid = document.getElementById('unitBtnGrid');
            const unitKeys = Object.keys(units);
            if (unitKeys.length === 0) { grid.innerHTML = "<div style='grid-column: span 2;'>No data found.</div>"; return; }
            grid.innerHTML = unitKeys.map(u => `<button class="nav-btn" onclick="selectUnit('${u}')">${u}</button>`).join(''); 
        }

        function selectUnit(u) { currentUnit = u; document.getElementById('unitSelection').classList.add('hidden'); document.getElementById('listSelection').classList.remove('hidden'); document.getElementById('listBtnGrid').innerHTML = Object.keys(units[u]).map(l => `<button class="nav-btn" onclick="selectList('${l}')">${l}</button>`).join(''); }
        function selectList(l) { currentClass = l; document.getElementById('listSelection').classList.add('hidden'); document.getElementById('studyInterface').classList.remove('hidden'); document.getElementById('activeListName').innerText = l; setStudyMode('list'); }
        function backToUnits() { document.getElementById('listSelection').classList.add('hidden'); document.getElementById('unitSelection').classList.remove('hidden'); }
        function backToLists() { document.getElementById('studyInterface').classList.add('hidden'); document.getElementById('listSelection').classList.remove('hidden'); }

        function setStudyMode(mode) {
            ['tabList', 'tabFlash', 'tabQuiz', 'tabMatch'].forEach(t => document.getElementById(t).classList.remove('active'));
            document.getElementById('tab' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');
            ['listMode', 'flashMode', 'quizMode', 'matchMode'].forEach(m => document.getElementById(m).classList.add('hidden'));
            document.getElementById(mode + 'Mode').classList.remove('hidden');
            const list = units[currentUnit][currentClass];
            if (mode === 'list') { renderFullList(list); updateHistoryUI(); }
            if (mode === 'flash') { cardIdx = 0; updateCard(list); }
            if (mode === 'quiz') startQuiz(list);
            if (mode === 'match') startMatch(list);
        }

        function renderFullList(list) { 
            document.getElementById('fullListArea').innerHTML = list.map(i => `
                <div class="list-item">
                    ${i.img ? `<img src="${i.img}" class="list-img" onerror="this.style.display='none'">` : ''}
                    <div><strong>${i.t}</strong>: ${i.d}</div>
                </div>`).join(''); 
        }

        function updateCard(list) { 
            const card = list[cardIdx]; 
            const front = document.getElementById('displayFront');
            const back = document.getElementById('displayBack');
            
            front.innerHTML = `
                ${card.img ? `<img src="${card.img}" class="vocab-img" onerror="this.style.display='none'">` : ''}
                <div>${card.t}</div>
            `;
            back.innerText = card.d; 
            document.getElementById('cardContainer').classList.remove('flipped'); 
        }

        function addHistory(mode, score) { sessionHistory.unshift({ mode, score, list: currentClass, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) }); }
        function updateHistoryUI() { const container = document.getElementById('historyEntries'); if(sessionHistory.length === 0) { container.innerHTML = "No attempts yet."; return; } container.innerHTML = sessionHistory.map(h => `<div class="history-item"><span><strong>${h.mode}</strong> (${h.list})</span><span>${h.score} <small>${h.time}</small></span></div>`).join(''); }
        
        async function exportResult(mode, score) { 
            if (EXPORT_URL && !EXPORT_URL.includes("PASTE")) { 
                const payload = { action: "saveResult", name: studentName, unit: currentClass, mode: mode, score: score }; 
                fetch(EXPORT_URL, { method: 'POST', body: JSON.stringify(payload) }).catch(err => console.log("Export Note: Triggered."));
            } 
        }

        function changeCard(dir) { const list = units[currentUnit][currentClass]; cardIdx = (cardIdx + dir + list.length) % list.length; updateCard(list); }
        function startQuiz(list) { qScore = 0; qIdx = 0; qPool = [...list].sort(() => 0.5 - Math.random()).slice(0, 5); document.getElementById('quizContent').classList.remove('hidden'); document.getElementById('quizEnd').classList.add('hidden'); document.getElementById('quizStats').innerText = `Score: 0/0`; renderQuiz(); }
        function renderQuiz() { if (qIdx >= qPool.length) { endQuiz(); return; } const list = units[currentUnit][currentClass]; const correct = qPool[qIdx]; const options = [correct, ...list.filter(i => i.t !== correct.t).sort(() => 0.5 - Math.random()).slice(0, 3)].sort(() => 0.5 - Math.random()); document.getElementById('quizQuestion').innerText = `What is: ${correct.t}?`; document.getElementById('quizOptions').innerHTML = options.map(o => `<div class="quiz-option" onclick="checkQuiz(this, ${o.t === correct.t})">${o.d}</div>`).join(''); document.getElementById('nextQuizBtn').classList.add('hidden'); }
        function checkQuiz(el, isCorrect) { if (!document.getElementById('nextQuizBtn').classList.contains('hidden')) return; if (isCorrect) { qScore++; el.classList.add('correct'); } else { el.classList.add('incorrect'); } qIdx++; document.getElementById('quizStats').innerText = `Score: ${qScore}/${qIdx}`; document.getElementById('nextQuizBtn').classList.remove('hidden'); }
        function endQuiz() { document.getElementById('quizContent').classList.add('hidden'); const pct = Math.round((qScore/qPool.length)*100) + "%"; document.getElementById('quizEnd').innerHTML = `<h3>Result: ${pct}</h3><button class="main-btn" onclick="startQuiz(units[currentUnit][currentClass])">Restart</button>`; document.getElementById('quizEnd').classList.remove('hidden'); addHistory("Quiz", pct); exportResult("Quiz", pct); }
        function startMatch(list) { mCorrect = 0; mTotal = 0; const sub = [...list].sort(() => 0.5 - Math.random()).slice(0, 5); mGoal = sub.length; document.getElementById('matchStats').innerText = "Accuracy: 0%"; document.getElementById('matchContainer').classList.remove('hidden'); document.getElementById('matchEnd').classList.add('hidden'); let words = sub.map((x, i) => ({t: x.t, id: i, type: 'w'})).sort(() => 0.5 - Math.random()); let defs = sub.map((x, i) => ({t: x.d, id: i, type: 'd'})).sort(() => 0.5 - Math.random()); document.getElementById('matchContainer').innerHTML = `<div class="match-col">${words.map(i => `<div class="match-item" draggable="true" ondragstart="drag(event)" data-id="${i.id}" data-type="w">${i.t}</div>`).join('')}</div><div class="match-col">${defs.map(i => `<div class="match-item" ondragover="event.preventDefault()" ondrop="drop(event)" data-id="${i.id}" data-type="d">${i.t}</div>`).join('')}</div>`; }
        function drag(e) { draggedItem = e.target; }
        function drop(e) { const target = e.target.closest('.match-item'); if (!target || !draggedItem) return; mTotal++; if (draggedItem.dataset.id === target.dataset.id && draggedItem.dataset.type !== target.dataset.type) { mCorrect++; draggedItem.style.visibility = 'hidden'; target.style.visibility = 'hidden'; } const acc = Math.round((mCorrect / mTotal) * 100) + "%"; document.getElementById('matchStats').innerText = `Accuracy: ${acc}`; if (mCorrect === mGoal) { document.getElementById('matchContainer').classList.add('hidden'); document.getElementById('matchEnd').innerHTML = `<h3>Match Accuracy: ${acc}</h3><button class="main-btn" onclick="startMatch(units[currentUnit][currentClass])">Again</button>`; document.getElementById('matchEnd').classList.remove('hidden'); addHistory("Match", acc); exportResult("Match", acc); } }

        function populateAdminDropdown() { 
            const dropdown = document.getElementById('adminDropdown'); 
            const currentVal = dropdown.value; 
            dropdown.innerHTML = '<option value="">-- Select List --</option>'; 
            Object.keys(units).forEach(u => Object.keys(units[u]).forEach(l => { 
                dropdown.innerHTML += `<option value="${u}|${l}">${u} - ${l}</option>`; 
            })); 
            dropdown.value = currentVal; 
        }

        function renderAdminList(val) { 
            if (!val) { document.getElementById('addWordForm').classList.add('hidden'); document.getElementById('adminWordList').innerHTML = ''; return; }
            const [u, l] = val.split('|');
            document.getElementById('addWordForm').classList.remove('hidden');
            document.getElementById('adminWordList').innerHTML = units[u][l].map((item, idx) => `
                <div class="edit-row">
                    <label>Term:</label> <input type="text" id="t-${idx}" value="${item.t}">
                    <label>Def:</label> <input type="text" id="d-${idx}" value="${item.d}">
                    <label>Img:</label> <input type="text" id="i-${idx}" value="${item.img || ''}">
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="main-btn" style="background:var(--accent); margin:0;" onclick="saveEdit('${u}','${l}',${idx})">Update Word</button>
                        <button class="delete-btn" id="delBtn-${idx}" onclick="deleteWord('${u}','${l}',${idx})">
                            <span class="spinner"></span>
                            <span class="btn-text">Delete</span>
                        </button>
                    </div>
                </div>`).join('');
        }

        async function submitNewWord() {
            const btn = document.getElementById('addWordBtn');
            const dropdown = document.getElementById('adminDropdown');
            if(!dropdown.value) return;
            const [u, l] = dropdown.value.split('|');
            btn.classList.add('loading'); btn.disabled = true;
            const payload = JSON.stringify({ action: "addWord", unit: u, list: l, term: document.getElementById('newT').value, def: document.getElementById('newD').value, img: document.getElementById('newI').value });
            try {
                await fetch(EXPORT_URL, { method: 'POST', mode: 'no-cors', body: payload });
                alert("Added! Syncing...");
                document.getElementById('newT').value = ""; document.getElementById('newD').value = ""; document.getElementById('newI').value = "";
                await new Promise(r => setTimeout(r, 1500)); 
                await fetchTeacherData(); 
                renderAdminList(dropdown.value);
            } finally { btn.classList.remove('loading'); btn.disabled = false; }
        }

        async function saveEdit(u, l, idx) {
            const dropdown = document.getElementById('adminDropdown');
            const payload = JSON.stringify({ action: "updateWord", unit: u, list: l, oldTerm: units[u][l][idx].t, newTerm: document.getElementById(`t-${idx}`).value, newDef: document.getElementById(`d-${idx}`).value, newImg: document.getElementById(`i-${idx}`).value });
            await fetch(EXPORT_URL, { method: 'POST', mode: 'no-cors', body: payload });
            alert("Update request sent!");
            await new Promise(r => setTimeout(r, 1200));
            await fetchTeacherData();
            renderAdminList(dropdown.value);
        }

        async function deleteWord(u, l, idx) {
            if(!confirm("Delete this word?")) return;
            const btn = document.getElementById(`delBtn-${idx}`);
            const dropdown = document.getElementById('adminDropdown');
            btn.classList.add('loading'); btn.disabled = true;
            const payload = JSON.stringify({ action: "deleteWord", unit: u, list: l, term: units[u][l][idx].t });
            try {
                await fetch(EXPORT_URL, { method: 'POST', mode: 'no-cors', body: payload });
                alert("Deleted! Syncing...");
                await new Promise(r => setTimeout(r, 1500)); 
                await fetchTeacherData();
                renderAdminList(dropdown.value);
            } finally { if(btn) { btn.classList.remove('loading'); btn.disabled = false; } }
        }

        function protectedToggle() { 
            if (document.getElementById('adminView').classList.contains('hidden')) { 
                if (prompt("Password:") === ADMIN_PASS) { 
                    document.getElementById('studyView').classList.add('hidden'); 
                    document.getElementById('adminView').classList.remove('hidden'); 
                    document.querySelector('.app-container').style.opacity = '1';
                    document.querySelector('.app-container').style.pointerEvents = 'auto';
                } 
            } else { 
                document.getElementById('adminView').classList.add('hidden'); 
                document.getElementById('studyView').classList.remove('hidden'); 
            } 
        }
    </script>
</body>
</html>