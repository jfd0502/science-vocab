<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Sojourn</title>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #0f172a; --accent: #16a34a; --danger: #dc2626; }
        body { font-family: 'Segoe UI', sans-serif; background: rgb(10, 15, 28); color: var(--text); padding: 0; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; position: relative; overflow-x: hidden; }
        
        /* App Layout */
        .app-container { position: relative; z-index: 10; padding: 60px 20px 20px 20px; width: 100%; max-width: 600px; display: flex; flex-direction: column; }
        .mode-toggle { position: absolute; top: 15px; left: 15px; z-index: 100; background: #64748b; color: white; border: none; border-radius: 8px; padding: 8px 14px; font-size: 0.75rem; cursor: pointer; }
        
        #matrixCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        #landingPage { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgb(10, 15, 28); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        .welcome-title { font-size: 3.5rem; font-weight: 800; letter-spacing: -1px; margin-bottom: 20px; color: white; text-shadow: 0 0 25px rgba(37, 99, 235, 1); }
        .sojourn-def { font-style: italic; font-size: 1.2rem; color: #f8fafc; margin-bottom: 40px; text-align: center; max-width: 80%; }
        .start-btn { background: var(--primary); color: white; border: none; padding: 18px 36px; font-size: 1.2rem; font-weight: bold; border-radius: 50px; cursor: pointer; }
        
        #loaderOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); display:none; flex-direction:column; align-items:center; justify-content:center; z-index: 200000; color: white; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); display: flex; align-items: center; justify-content: center; z-index: 50000; color: white; }
        .login-box { background: white; color: var(--text); padding: 30px; border-radius: 15px; text-align: center; width: 90%; max-width: 400px; }
        
        .nav-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin: 10px 0; }
        .nav-btn { background: white; border: 2px solid #e2e8f0; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
        .nav-btn:hover { background: #f8fafc; }
        .breadcrumb { font-size: 0.9rem; color: #64748b; margin-bottom: 10px; cursor: pointer; text-align: left; width: 100%; }
        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; width: 100%; box-sizing: border-box; }
        
        .hidden { display: none !important; }
        
        input, select, .main-btn { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #cbd5e1; box-sizing: border-box; }
        .main-btn { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        .delete-btn { background: var(--danger); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; margin-top: 5px; }
        .edit-row { background: #f8fafc; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="loaderOverlay">
        <div class="spinner"></div>
        <div>Syncing with Cloud...</div>
    </div>

    <canvas id="matrixCanvas"></canvas>

    <div id="landingPage">
        <h1 class="welcome-title">Vocabulary Sojourn</h1>
        <div class="sojourn-def">so-journ (n): a temporary stay in a place.</div>
        <button class="start-btn" onclick="enterApp()">Click Here to Start Your Journey</button>
    </div>

    <div id="loginOverlay" class="hidden">
        <div class="login-box">
            <h2>Student Entry</h2>
            <input type="text" id="studentNameInput" placeholder="Enter Full Name...">
            <button class="main-btn" onclick="saveStudentName()">Continue</button>
        </div>
    </div>

    <button id="managerBtn" class="mode-toggle hidden" onclick="protectedToggle()">Manager Mode</button>

    <div id="mainApp" class="app-container hidden">
        <div id="syncStatus" style="font-size: 0.75rem; color: #94a3b8; text-align:center; margin-bottom:10px;">Connecting...</div>
        
        <div id="studyView" class="panel">
            <div id="unitSelection">
                <label><strong>Select Unit</strong></label>
                <div id="unitBtnGrid" class="nav-grid"></div>
            </div>
            <div id="listSelection" class="hidden">
                <div class="breadcrumb" onclick="backToUnits()">&larr; Back to Units</div>
                <div id="listBtnGrid" class="nav-grid"></div>
            </div>
            <div id="studyInterface" class="hidden">
                <div class="breadcrumb" onclick="backToLists()">&larr; Back to Lists</div>
                <h3 id="activeListName" style="margin:5px 0;"></h3>
                <div id="studentWelcome" style="font-size: 0.8rem; color: #64748b; margin-bottom: 10px;"></div>
                <div id="fullListArea"></div>
            </div>
        </div>

        <div id="adminView" class="panel hidden">
            <div class="breadcrumb" onclick="protectedToggle()">&larr; Exit Manager</div>
            <h3>Manager Mode (Live Edit)</h3>
            <select id="adminDropdown" onchange="renderAdminList(this.value)"></select>
            <div id="addWordForm" class="hidden">
                <h4 style="margin-bottom:10px;">+ Add New Word</h4>
                <input type="text" id="newT" placeholder="New Term">
                <input type="text" id="newD" placeholder="New Definition">
                <input type="text" id="newI" placeholder="Image URL (optional)">
                <button class="main-btn" onclick="submitNewWord()">Add Word to Sheet</button>
                <hr style="margin: 20px 0;">
            </div>
            <div id="adminWordList"></div>
        </div>
    </div>

    <script>
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSwbPmk1KJuwC8y8oBy_oKB7N8LMfgJcA7LykdRSsaAj-imKQnf4ZkF6h6A28P74Ibx-lRtHclXtlF4/pub?gid=0&single=true&output=csv";
        const EXPORT_URL = "https://script.google.com/macros/s/AKfycby0uL9qB0Ea7O7Yn_K38B7k8W2F-Iq1z-L6oG6rR_G5v8M1z-L6oG6rR_G5v8M1z-L6/exec"; 
        const ADMIN_PASS = "science123";

        let units = {}, currentUnit = "", currentClass = "", studentName = "";
        let vocabWords = ["Sojourn", "Voyage", "Discovery"]; 

        const canvas = document.getElementById('matrixCanvas');
        const ctx = canvas.getContext('2d');
        let columns = [];
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; columns = Array(Math.floor(canvas.width / 20)).fill(0); }
        function drawMatrix() { ctx.fillStyle = "rgba(10, 15, 28, 0.15)"; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = "#3b82f6"; ctx.font = "bold 15px monospace"; columns.forEach((y, i) => { const word = vocabWords[Math.floor(Math.random() * vocabWords.length)]; ctx.fillText(word, i * 25, y); if (y > canvas.height && Math.random() > 0.95) columns[i] = 0; else columns[i] = y + 25; }); }
        window.onload = () => { fetchTeacherData(); resizeCanvas(); setInterval(drawMatrix, 50); };

        function showSpinner(show) { document.getElementById('loaderOverlay').style.display = show ? 'flex' : 'none'; }

        async function fetchTeacherData() {
            try {
                const response = await fetch(SHEET_CSV_URL + '?cb=' + new Date().getTime()); 
                const csvText = await response.text();
                const rows = csvText.split(/\r?\n/).slice(1); 
                units = {}; 
                rows.forEach(row => {
                    const splitCols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if (splitCols.length >= 2) {
                        const t = splitCols[0].replace(/"/g, ''), d = splitCols[1].replace(/"/g, ''), i = (splitCols[2]||'').replace(/"/g, ''), l = (splitCols[3]||'').replace(/"/g, ''), u = (splitCols[4]||'').replace(/"/g, '');
                        if (!units[u]) units[u] = {}; if (!units[u][l]) units[u][l] = []; units[u][l].push({t, d, img: i});
                    }
                });
                renderUnitSelection(); populateAdminDropdown(); document.getElementById('syncStatus').innerText = "Sync Active";
            } catch (e) { document.getElementById('syncStatus').innerText = "Sync Error"; }
        }

        async function refreshDataOnly() {
            showSpinner(true);
            await fetchTeacherData();
            const val = document.getElementById('adminDropdown').value;
            if (val) renderAdminList(val); 
            showSpinner(false);
        }

        function enterApp() { 
            document.getElementById('landingPage').classList.add('hidden'); 
            document.getElementById('loginOverlay').classList.remove('hidden'); 
        }

        function saveStudentName() { 
            studentName = document.getElementById('studentNameInput').value; 
            if(studentName.trim()){ 
                document.getElementById('loginOverlay').classList.add('hidden'); 
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('managerBtn').classList.remove('hidden');
                document.getElementById('studentWelcome').innerText = "Student: " + studentName; 
            } 
        }

        function renderUnitSelection() { document.getElementById('unitBtnGrid').innerHTML = Object.keys(units).map(u => `<button class="nav-btn" onclick="selectUnit('${u}')">${u}</button>`).join(''); }
        function selectUnit(u) { currentUnit = u; document.getElementById('unitSelection').classList.add('hidden'); document.getElementById('listSelection').classList.remove('hidden'); document.getElementById('listBtnGrid').innerHTML = Object.keys(units[u]).map(l => `<button class="nav-btn" onclick="selectList('${l}')">${l}</button>`).join(''); }
        function selectList(l) { currentClass = l; document.getElementById('listSelection').classList.add('hidden'); document.getElementById('studyInterface').classList.remove('hidden'); document.getElementById('activeListName').innerText = l; renderFullList(units[currentUnit][l]); }
        function renderFullList(list) { document.getElementById('fullListArea').innerHTML = list.map(i => `<div style="padding:10px; border-bottom:1px solid #eee;"><strong>${i.t}</strong>: ${i.d}</div>`).join(''); }
        function backToUnits() { document.getElementById('listSelection').classList.add('hidden'); document.getElementById('unitSelection').classList.remove('hidden'); }
        function backToLists() { document.getElementById('studyInterface').classList.add('hidden'); document.getElementById('listSelection').classList.remove('hidden'); }

        function populateAdminDropdown() { 
            const dropdown = document.getElementById('adminDropdown');
            const currentVal = dropdown.value;
            dropdown.innerHTML = '<option value="">-- Select List --</option>'; 
            Object.keys(units).forEach(u => Object.keys(units[u]).forEach(l => { dropdown.innerHTML += `<option value="${u}|${l}">${u} - ${l}</option>`; }));
            dropdown.value = currentVal;
        }

        function renderAdminList(val) { 
            if (!val) { document.getElementById('addWordForm').classList.add('hidden'); document.getElementById('adminWordList').innerHTML = ''; return; }
            const [u, l] = val.split('|');
            document.getElementById('addWordForm').classList.remove('hidden');
            document.getElementById('adminWordList').innerHTML = (units[u][l] || []).map((item, idx) => `
                <div class="edit-row">
                    <input type="text" id="t-${idx}" value="${item.t}">
                    <input type="text" id="d-${idx}" value="${item.d}">
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="main-btn" style="background:var(--accent); margin:0;" onclick="saveEdit('${u}','${l}',${idx})">Update</button>
                        <button class="delete-btn" onclick="deleteWord('${u}','${l}',${idx})">Delete</button>
                    </div>
                </div>`).join('');
        }

        async function submitNewWord() {
            const [u, l] = document.getElementById('adminDropdown').value.split('|');
            const payload = { action: "addWord", unit: u, list: l, term: document.getElementById('newT').value, def: document.getElementById('newD').value, img: document.getElementById('newI').value };
            await fetch(EXPORT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            document.getElementById('newT').value = ""; document.getElementById('newD').value = "";
            refreshDataOnly();
        }

        async function saveEdit(u, l, idx) {
            const payload = { action: "updateWord", unit: u, list: l, oldTerm: units[u][l][idx].t, newTerm: document.getElementById(`t-${idx}`).value, newDef: document.getElementById(`d-${idx}`).value, newImg: "" };
            await fetch(EXPORT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            refreshDataOnly();
        }

        async function deleteWord(u, l, idx) {
            if(!confirm("Delete?")) return;
            const payload = { action: "deleteWord", unit: u, list: l, term: units[u][l][idx].t };
            await fetch(EXPORT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            refreshDataOnly();
        }

        function protectedToggle() { if (document.getElementById('adminView').classList.contains('hidden')) { if (prompt("Password:") === ADMIN_PASS) { document.getElementById('studyView').classList.add('hidden'); document.getElementById('adminView').classList.remove('hidden'); } } else { document.getElementById('adminView').classList.add('hidden'); document.getElementById('studyView').classList.remove('hidden'); } }
    </script>
</body>
</html>