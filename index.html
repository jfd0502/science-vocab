<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8th Grade Science Pro</title>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #0f172a; --accent: #16a34a; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 600px; margin-bottom: 20px; }
        .hidden { display: none !important; }
        
        /* Flashcards */
        .flashcard { height: 280px; perspective: 1000px; cursor: pointer; margin: 20px 0; width: 100%; }
        .inner { position: relative; width: 100%; height: 100%; transition: 0.6s; transform-style: preserve-3d; border: 2px solid #e2e8f0; border-radius: 15px; }
        .flipped .inner { transform: rotateY(180deg); }
        .front, .back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1.4rem; padding: 20px; text-align: center; box-sizing: border-box; border-radius: 13px; background: white; }
        .back { background: var(--primary); color: white; transform: rotateY(180deg); font-size: 1.1rem; overflow-y: auto; }
        .card-img { max-height: 120px; max-width: 100%; border-radius: 8px; margin-top: 10px; object-fit: contain; background: white; padding: 5px; }

        /* Match Mode */
        .match-container { display: flex; gap: 15px; margin-top: 10px; }
        .match-col { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .match-item { padding: 15px; background: white; border: 2px solid #cbd5e1; border-radius: 8px; cursor: grab; text-align: center; font-size: 0.9rem; user-select: none; transition: all 0.2s; min-height: 60px; display: flex; align-items: center; justify-content: center; }
        .match-item:hover { border-color: var(--primary); background: #f8fafc; }
        #accuracyDisplay { text-align: right; font-weight: bold; margin-bottom: 5px; color: var(--primary); font-size: 1.1rem; }

        /* UI Components */
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #cbd5e1; box-sizing: border-box; font-size: 1rem; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        .mode-toggle { background: #64748b; margin-bottom: 20px; }
        .study-tabs { display: flex; gap: 5px; margin-top: 15px; }
        .study-tabs button { background: #e2e8f0; color: #475569; padding: 10px; font-size: 0.9rem; flex: 1; }
        .study-tabs button.active { background: var(--primary); color: white; }
        #syncStatus { font-size: 0.85rem; color: #64748b; margin-bottom: 10px; text-align: center; font-style: italic; }
    </style>
</head>
<body>

    <h1>Science Vocab Master</h1>
    <div id="syncStatus">Syncing with Teacher's Sheet...</div>
    
    <button class="mode-toggle" onclick="protectedToggle()">Switch to Manager / Study Mode</button>

    <div id="studyView" class="panel">
        <label><strong>Select Unit:</strong></label>
        <select class="class-sync" onchange="loadClass(this.value)"></select>
        
        <div class="study-tabs">
            <button id="tabList" class="active" onclick="setStudyMode('list')">List</button>
            <button id="tabFlash" onclick="setStudyMode('flash')">Flashcards</button>
            <button id="tabMatch" onclick="setStudyMode('match')">Matching</button>
        </div>

        <div id="listMode"><div id="fullListArea"></div></div>

        <div id="cardMode" class="hidden">
            <div class="flashcard" id="cardContainer" onclick="this.classList.toggle('flipped')">
                <div class="inner">
                    <div class="front" id="displayTerm"></div>
                    <div class="back" id="displayDef"></div>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="changeCard(-1)">Previous</button>
                <button onclick="changeCard(1)">Next</button>
            </div>
        </div>

        <div id="matchMode" class="hidden">
            <div id="accuracyDisplay">Accuracy: 0%</div>
            <div class="match-container" id="matchContainer"></div>
        </div>
    </div>

    <div id="adminView" class="panel hidden">
        <h3>1. Create Vocabulary List</h3>
        <input type="text" id="newClassName" placeholder="New List Name">
        <button onclick="addClass()" style="background: var(--accent);">Create List</button>
        <hr>
        <h3>2. Manage Vocabulary List</h3>
        <select class="class-sync" onchange="loadClass(this.value)"></select>
        <input type="text" id="newTerm" placeholder="Word">
        <input type="text" id="newDef" placeholder="Definition">
        <input type="text" id="newImg" placeholder="Image URL (Optional)">
        <button onclick="addWord()">Add Word</button>
        <div id="adminWordList"></div>
    </div>

    <script>
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSwbPmk1KJuwC8y8oBy_oKB7N8LMfgJcA7LykdRSsaAj-imKQnf4ZkF6h6A28P74Ibx-lRtHclXtlF4/pub?gid=0&single=true&output=csv";
        const ADMIN_PASS = "science123"; // CHANGE YOUR PASSWORD HERE

        let data = JSON.parse(localStorage.getItem('science_v16_data')) || {};
        let currentClass = "";
        let cardIdx = 0;
        let currentMode = 'list';
        let matchesFound = 0;
        let totalAttempts = 0;

        window.onload = fetchTeacherData;

        async function fetchTeacherData() {
            try {
                const response = await fetch(SHEET_CSV_URL);
                const csvText = await response.text();
                const rows = csvText.split('\n').slice(1);
                
                rows.forEach(row => {
                    // Regex handles commas inside quotes
                    const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                    if (cols && cols.length >= 4) {
                        const term = cols[0].replace(/"/g, '').trim();
                        const def = cols[1].replace(/"/g, '').trim();
                        const img = cols[2].replace(/"/g, '').trim();
                        const list = cols[3].replace(/"/g, '').trim();
                        
                        if (!data[list]) data[list] = [];
                        if (!data[list].some(item => item.t === term)) {
                            data[list].push({t: term, d: def, img: img});
                        }
                    }
                });
                document.getElementById('syncStatus').innerText = "? Master Sheet Connected";
            } catch (e) {
                document.getElementById('syncStatus').innerText = "?? Offline / Local Mode";
            }
            initApp();
        }

        function initApp() {
            const keys = Object.keys(data);
            if (keys.length > 0) {
                currentClass = keys[0];
                renderClassOptions();
                setStudyMode('list');
            }
        }

        function protectedToggle() {
            if (document.getElementById('adminView').classList.contains('hidden')) {
                const pass = prompt("Enter Teacher Password:");
                if (pass === ADMIN_PASS) toggleMainView();
                else alert("Incorrect Password");
            } else {
                toggleMainView();
            }
        }

        function toggleMainView() {
            document.getElementById('studyView').classList.toggle('hidden');
            document.getElementById('adminView').classList.toggle('hidden');
            renderAdminList();
        }

        function setStudyMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.study-tabs button').forEach(b => b.classList.remove('active'));
            document.getElementById('tab' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');
            ['listMode', 'cardMode', 'matchMode'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(mode + 'Mode').classList.remove('hidden');
            
            if (mode === 'list') renderFullList();
            if (mode === 'flash') { cardIdx = 0; updateCard(); }
            if (mode === 'match') { matchesFound = 0; totalAttempts = 0; updateAccuracy(); renderMatching(); }
        }

        function renderFullList() {
            const list = data[currentClass] || [];
            document.getElementById('fullListArea').innerHTML = list.map(item => `
                <div style="padding:15px; border-bottom:1px solid #e2e8f0;">
                    <strong style="color:var(--primary);">${item.t}</strong>: ${item.d}
                </div>
            `).join('');
        }

        function updateCard() {
            const list = data[currentClass] || [];
            if (!list.length) return;
            document.getElementById('displayTerm').innerText = list[cardIdx].t;
            let defContent = `<div>${list[cardIdx].d}</div>`;
            if (list[cardIdx].img && list[cardIdx].img !== "") {
                defContent += `<img src="${list[cardIdx].img}" class="card-img" onerror="this.style.display='none'">`;
            }
            document.getElementById('displayDef').innerHTML = defContent;
            document.getElementById('cardContainer').classList.remove('flipped');
        }

        function changeCard(dir) {
            const list = data[currentClass] || [];
            cardIdx = (cardIdx + dir + list.length) % list.length;
            updateCard();
        }

        /* --- MATCHING LOGIC --- */
        let draggedItem = null;
        function updateAccuracy() {
            const acc = totalAttempts === 0 ? 0 : Math.round((matchesFound / totalAttempts) * 100);
            document.getElementById('accuracyDisplay').innerText = `Accuracy: ${acc}%`;
        }

        function renderMatching() {
            const list = data[currentClass] || [];
            const container = document.getElementById('matchContainer');
            if (list.length < 2) { container.innerHTML = "Not enough words."; return; }
            
            let words = list.map((item, i) => ({ text: item.t, id: i, type: 'word' }));
            let defs = list.map((item, i) => ({ text: item.d, id: i, type: 'def' }));
            words.sort(() => Math.random() - 0.5);
            defs.sort(() => Math.random() - 0.5);

            container.innerHTML = `
                <div class="match-col">${words.map(w => `<div class="match-item" draggable="true" ondragstart="drag(event)" data-id="${w.id}" data-type="word">${w.text}</div>`).join('')}</div>
                <div class="match-col">${defs.map(d => `<div class="match-item" ondragover="allowDrop(event)" ondrop="drop(event)" data-id="${d.id}" data-type="def">${d.text}</div>`).join('')}</div>`;
        }

        function drag(e) { draggedItem = e.target; }
        function allowDrop(e) { e.preventDefault(); }
        function drop(e) {
            e.preventDefault();
            const target = e.target;
            if (draggedItem.dataset.type === target.dataset.type) return; 
            
            totalAttempts++;
            if (draggedItem.dataset.id === target.dataset.id) {
                matchesFound++;
                draggedItem.style.visibility = 'hidden';
                target.style.visibility = 'hidden';
            }
            updateAccuracy();
        }

        /* --- ADMIN FUNCTIONS --- */
        function addWord() {
            const t = document.getElementById('newTerm').value;
            const d = document.getElementById('newDef').value;
            const img = document.getElementById('newImg').value;
            if (t && d) {
                data[currentClass].push({t, d, img});
                localStorage.setItem('science_v16_data', JSON.stringify(data));
                renderAdminList();
            }
        }

        function renderAdminList() {
            const list = data[currentClass] || [];
            document.getElementById('adminWordList').innerHTML = list.map((item, i) => `
                <div style="padding:5px; border-bottom:1px solid #eee;">${item.t}</div>
            `).join('');
        }

        function renderClassOptions() {
            const selects = document.querySelectorAll('.class-sync');
            const options = Object.keys(data).map(c => `<option value="${c}" ${c===currentClass?'selected':''}>${c}</option>`).join('');
            selects.forEach(s => s.innerHTML = options);
        }

        function loadClass(val) { currentClass = val; setStudyMode(currentMode); renderAdminList(); }
    </script>
</body>
</html>